<% content_for :title, @post.title %>

<div class="post-show-wrapper">
  <article class="post-article">
    <h1 class="post-title"><%= @post.title %></h1>

    <div class="post-meta">
      <div class="post-author">
        <% if @post.user %>
          <%= link_to @post.user do %>
            <div class="post-avatar"><%= @post.user.name.first.upcase %></div>
          <% end %>
          <span><%= link_to(@post.user.name.presence || @post.user.email, @post.user, class: "post-author-link") %></span>
        <% else %>
          <div class="post-avatar">U</div>
          <span>Unknown author</span>
        <% end %>
      </div>

      <span>â€¢</span>

      <time datetime="<%= (@post.published_at || @post.created_at).iso8601 %>">
        <%= l(@post.published_at || @post.created_at, format: :long) %>
      </time>

    </div>

    <div class="post-body">
      <%= simple_format(h(@post.body)) %>
    </div>

    <% if @post.image.attached? %>
      <div class="post-figure mb-5">
        <%= image_tag url_for(@post.image), class: "post-imag", alt: @post.title %>
      </div>
    <% end %>

    <div class="post-actions">
      <% if @post.published? %>
        <%= render "likes/like_button", post: @post %>
      <% end %>

      <% if current_user && owner?(@post) %>
        <%= link_to edit_post_path(@post), class: "btn-outline" do %>
          <svg class="h-4 w-4 text-slate-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" d="M16.862 3.487a2.25 2.25 0 0 1 3.182 3.182L8.25 18.463l-4.5 1.125L4.875 15l11.987-11.513z"/>
            <path stroke-linecap="round" stroke-linejoin="round" d="M15 5l4 4"/>
          </svg>
          Edit
        <% end %>

        <% unless @post.published? %>
          <%= button_to publish_post_path(@post),
                 method: :patch,
                 class: "btn-primary",
                 form: { data: { turbo_confirm: "Publish this draft?" } } do %>
            Publish now
          <% end %>
          <%= link_to drafts_posts_path, class: "btn-outline" do %>
            Back to drafts
          <% end %>
        <% end %>
      <% end %>

      <% if current_user && owns?(@post) %>
        <%= button_to @post, method: :delete, class: "btn-danger",
              data: { turbo_confirm: "Are you sure you want to delete this post?" } do %>
          <svg class="h-4 w-4 text-white" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" d="M6 7h12M9 7V5a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v2M19 7l-1 12a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 7"/>
            <path stroke-linecap="round" stroke-linejoin="round" d="M10 11v6M14 11v6"/>
          </svg>
          Delete
        <% end %>
      <% end %>
      <% if @post.published? %>
        <%= link_to posts_path, class: "btn-outline" do %>
          <svg class="h-4 w-4 text-slate-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7"/>
          </svg>
          Back
        <% end %>
      <% end %>
    </div>
  </article>

  <% if @post.published? %>
    <section id="comments" class="comments-section">
      <div class="comments-header">
        <div>
          <h2 class="comments-title">Discussion</h2>
          <p class="comments-subtitle">Join the conversation below</p>
        </div>
        <span class="comments-count"><%= pluralize(@post.comments.count, "comment").upcase %></span>
      </div>

      <div class="comments-list">
        <% if @comments.any? %>
          <%= render partial: "comments/comment", collection: @comments, as: :comment, locals: { post: @post, depth: 0 } %>
        <% else %>
          <p class="comments-empty">No comments yet. Be the first to share your thoughts!</p>
        <% end %>
      </div>

      <div class="comments-form-wrapper">
        <% if current_user %>
          <%= render "comments/form", post: @post, comment: @new_comment %>
        <% else %>
          <div class="comments-login-callout">
            <p>
              <%= link_to "Log in", login_path, class: "comments-login-link" %> to join the conversation.
            </p>
          </div>
        <% end %>
      </div>
    </section>
  <% elsif current_user && owns?(@post) %>
    <section class="comments-section comments-section--draft">
      <div class="draft-note">
        <h2>This draft is private</h2>
        <p>Publish the post to enable comments and likes.</p>
      </div>
    </section>
  <% end %>
</div>
