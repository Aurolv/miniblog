<% depth = local_assigns.fetch(:depth, 0) %>
<div class="comment-thread <%= depth.positive? ? 'comment-thread--nested' : 'comment-thread--root' %>">
  <article id="<%= dom_id(comment) %>" class="comment-bubble">
    <header class="comment-header">
      <div class="comment-user">
        <% if comment.user %>
          <%= link_to comment.user, class: "comment-avatar" do %>
            <%= (comment.user.name.presence || comment.user.email).first.upcase %>
          <% end %>
        <% else %>
          <div class="comment-avatar">U</div>
        <% end %>

        <div>
          <p class="comment-author">
            <% if comment.user %>
              <%= link_to(comment.user.name.presence || comment.user.email, comment.user, class: "comment-author-link") %>
            <% else %>
              Anonymous
            <% end %>
          </p>
          <p class="comment-timestamp">
            <%= time_ago_in_words(comment.created_at) %> ago
          </p>
        </div>
      </div>

      <% if owns?(comment) %>
        <%= button_to comment_path(comment),
              method: :delete,
              class: "comment-delete-button",
              data: { turbo_confirm: "Are you sure you want to remove this comment?" } do %>
          <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" d="M18 6 6 18M6 6l12 12"/>
          </svg>
          Remove
        <% end %>
      <% end %>
    </header>

    <div class="comment-body">
      <%= simple_format(h(comment.body)) %>
    </div>

    <footer class="comment-footer">
      <%= render "likes/comment_like_button", comment: comment %>

      <% if current_user %>
        <% active_reply = defined?(@reply_target) && @reply_target == comment %>
        <% reply_form_comment = active_reply ? @reply_comment : Comment.new(parent: comment) %>
        <details class="comment-reply" <%= "open" if active_reply %>>
          <summary>Reply</summary>
          <div class="comment-reply-body">
            <%= render "comments/form", post: post, comment: reply_form_comment %>
          </div>
        </details>
      <% end %>
    </footer>
  </article>

  <% if comment.replies.any? %>
    <div class="comment-children">
      <%= render partial: "comments/comment",
                 collection: comment.replies.order(created_at: :asc),
                 as: :comment,
                 locals: { post: post, depth: depth + 1 } %>
    </div>
  <% end %>
</div>
